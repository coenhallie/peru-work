<!DOCTYPE html>
<html>
<head>
    <title>Update Craftsman Names</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 0;
        }
        button:hover {
            background: #357ae8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .success { color: #0f9d58; }
        .error { color: #d93025; }
        .info { color: #4285f4; }
    </style>
</head>
<body>
    <h1>Update Craftsman Names in Applications</h1>
    <p>This tool will update all job applications with "Unknown" craftsman name to the correct name from the users collection.</p>
    
    <button id="signInBtn" onclick="signIn()">Sign In with Email</button>
    <button id="updateBtn" onclick="updateApplications()" disabled>Update Applications</button>
    
    <div id="log"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDPAm3tZnBqE1Ng3oabXhXN8V6i4Dj4MYI",
            authDomain: "workapp-76f52.firebaseapp.com",
            projectId: "workapp-76f52",
            storageBucket: "workapp-76f52.firebasestorage.app",
            messagingSenderId: "353672933732",
            appId: "1:353672933732:web:4c3f4e8bd9f4cebaf12fcb"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                log(`Signed in as: ${user.email}`, 'success');
                document.getElementById('signInBtn').textContent = 'Signed In';
                document.getElementById('signInBtn').disabled = true;
                document.getElementById('updateBtn').disabled = false;
            }
        });

        async function signIn() {
            const email = prompt('Enter your email:');
            const password = prompt('Enter your password:');
            
            if (!email || !password) return;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                log('Sign in successful!', 'success');
            } catch (error) {
                log(`Sign in error: ${error.message}`, 'error');
            }
        }

        async function updateApplications() {
            const btn = document.getElementById('updateBtn');
            btn.disabled = true;
            btn.textContent = 'Updating...';
            
            try {
                log('Starting update process...', 'info');
                
                // Get all applications with "Unknown" craftsman name
                const applicationsSnapshot = await db.collection('job_applications')
                    .where('craftsmanName', '==', 'Unknown')
                    .get();
                
                log(`Found ${applicationsSnapshot.size} applications to update`, 'info');
                
                if (applicationsSnapshot.empty) {
                    log('No applications need updating!', 'success');
                    btn.textContent = 'Update Complete';
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;
                
                // Update each application
                for (const doc of applicationsSnapshot.docs) {
                    try {
                        const application = doc.data();
                        const craftsmanId = application.craftsmanId;
                        
                        // Get craftsman's actual name
                        const userDoc = await db.collection('users').doc(craftsmanId).get();
                        
                        if (userDoc.exists) {
                            const craftsmanName = userDoc.data().name || 'Unknown';
                            await doc.ref.update({ craftsmanName: craftsmanName });
                            log(`✓ Updated application ${doc.id} to craftsman: ${craftsmanName}`, 'success');
                            successCount++;
                        } else {
                            log(`✗ User not found for application ${doc.id}`, 'error');
                            errorCount++;
                        }
                    } catch (error) {
                        log(`✗ Error updating ${doc.id}: ${error.message}`, 'error');
                        errorCount++;
                    }
                }
                
                log(`\n=== Update Complete ===`, 'info');
                log(`Successfully updated: ${successCount}`, 'success');
                if (errorCount > 0) {
                    log(`Errors: ${errorCount}`, 'error');
                }
                
                btn.textContent = 'Update Complete';
                
            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'Update Applications';
            }
        }
    </script>
</body>
</html>